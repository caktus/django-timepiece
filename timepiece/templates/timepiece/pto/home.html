{% extends "timepiece/pto/base.html" %}
{% load bootstrap_toolkit %}
{% load url from future %}
{% load timepiece_tags %}

{% block title %}FirmBase: PTO{% endblock title %}

{% block content %}
<h2>Paid Time Off</h2>
<div class="row-fluid">
    <div class="span12" id="active-entry">
        <div>
            <span>Here you can view your <a href="javascript:changeActiveTab('summary');">available</a> PTO, PTO <a href="javascript:changeActiveTab('history');">history</a>, and <a href="{% url 'create_pto_request' %}">submit</a> and <a to="requests" href="javascript:changeActiveTab('requests');">track</a> requests for future PTO.</span>
            {% if perms.crm.can_approve_requests %}
            <span>Additionally, admins can <a to="requests" href="javascript:changeActiveTab('approvals');">approve<a/> open PTO requests and view PTO <a to="requests" href="javascript:changeActiveTab('all_history');">history</a>.
            {% endif %}
        </div>
        <div>
            <a type="button" class="btn btn-primary" href="{% url 'create_pto_request' %}">Request Time Off</a><p/>
        </div>
    </div>
</div>

<ul class="nav nav-tabs">
    <li{% if active_tab == 'summary' %} class="active"{% endif %}>
        {% url "pto" "summary" as link %}
        <a class="tab-link" to="summary" href="{{ link|add_parameters:request.GET }}">My PTO Summary</a>
    </li>
    <li{% if active_tab == 'requests' %} class="active"{% endif %}>
        {% url "pto" "requests" as link %}
        <a class="tab-link" to="requests" href="{{ link|add_parameters:request.GET }}">My PTO Requests</a>
    </li>
    <li{% if active_tab == 'history' %} class="active"{% endif %}>
        {% url "pto" "history" as link %}
        <a class="tab-link" to="history" href="{{ link|add_parameters:request.GET }}">My PTO History</a>
    </li>
    {% if perms.crm.can_approve_requests %}
    <li{% if active_tab == 'approvals' %} class="active"{% endif %}>
        {% url "pto" "approvals" as link %}
        <a class="tab-link" to="approvals" href="{{ link|add_parameters:request.GET }}">Open Requests</a>
    </li>
    <li{% if active_tab == 'all_history' %} class="active"{% endif %}>
        {% url "pto" "all_history" as link %}
        <a class="tab-link" to="all_history" href="{{ link|add_parameters:request.GET }}">All PTO History</a>
    </li>
    {% endif %}
</ul>

<div class="tab-content">

    <div class="tab-pane{% if active_tab == 'summary' %} active{% endif %}" id="summary">
        <div class="span4">
        <h3>My Available PTO</h3>
        <dl class="dl-horizontal">
            <dt>Available PTO</dt>
            <dd>{{ user_profile.get_pto }} hours</dd>

            <dt>Anniversary Date</dt>
            <dd>{{ user_profile.hire_date|date:"F d" }}</dd>
        </dl>
        </div>
        {% for holiday_year in holiday_years %}
            <div class="span4">
            <h3>{{ holiday_year.year }} Paid Holidays</h3>
            <dl class="dl-horizontal">
                {% for holiday in holiday_year.holidays %}
                <dt {% if holiday.date < today %}style="text-decoration: line-through;"{% endif %}>{{ holiday.name }}</dt>
                <dd {% if holiday.date < today %}style="text-decoration: line-through;"{% endif %}>{{ holiday.date }}</dd>
                {% endfor %}
            </dl>
        </div>
        {% endfor %}
    </div>

    <div class="tab-pane{% if active_tab == 'requests' %} active{% endif %}" id="requests">
      {% if pto_requests|length %}
        <table id="pto_requests" class="table table-striped table-bordered table-hover table-condensed">
            <thead><tr>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Hours</th>
                <th>Comment</th>
                <th>Actions</th>
            </tr></thead>
            <tbody>
              {% for ptor in pto_requests %}
                <tr id="{{ ptor.id }}">
                    <td>{{ ptor.pto_start_date }}</td>
                    <td>{{ ptor.pto_end_date }}</td>
                    <td>{{ ptor.amount }}</td>
                    <td>{{ ptor.comment }}</td>
                    <td>
                        <a type="button" class="btn btn-primary" href="{% url 'edit_pto_request' ptor.id %}">Edit</a>
                        <a type="button" class="btn btn-danger" href="{% url 'delete_pto_request' ptor.id %}">Delete</a>
                    </td>
                </tr>
              {% endfor %}
            </tbody>
        </table>
      {% else %}
        <div style="margin-bottom: 18px;"><h5>You have no open PTO requests.</h5></div>
      {% endif %}
    </div>

    <div class="tab-pane{% if active_tab == 'history' %} active{% endif %}" id="history">
      {% if pto_log|length %}
        <table id="pto_log" class="table table-striped table-bordered table-hover table-condensed">
            <thead><tr>
                <th>Date</th>
                <th>Hours</th>
                <th>Comment</th>
                <th>PTO Request</th>
            </tr></thead>
            <tbody>
                {% for pto in pto_log %}
                <tr id="{{pto.id}}">
                    <td>{{ pto.date }}</td>
                    <td>{{ pto.amount }}</td>
                    <td>{{ pto.comment }}</td>
                    <td>
                        {% if pto.pto_request %}
                        <a href="{% url 'pto_request_details' pto.pto_request.id %}">View PTO Request Details</a>
                        {% else %}
                        <label>---</label>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
      {% else %}
        <div style="margin-bottom: 18px;"><h5>You have no PTO history.</h5></div>
      {% endif %}
    </div>

    {% if perms.crm.can_approve_requests %}
    <div class="tab-pane{% if active_tab == 'approvals' %} active{% endif %}" id="approvals">
      {% if pto_approvals|length %}
        <table id="pto_approvals" class="table table-striped table-bordered table-hover table-condensed">
            <thead><tr>
                <th>Employee</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Hours</th>
                <th>Reason</th>
                <th>Actions</th>
            </tr></thead>
            <tbody>
              {% for ptor in pto_approvals %}
                <tr id="{{ ptor.id }}">
                    <td>{{ ptor.user_profile.user }}</td>
                    <td>{{ ptor.pto_start_date }}</td>
                    <td>{{ ptor.pto_end_date }}</td>
                    <td>{{ ptor.amount }}</td>
                    <td>{{ ptor.comment }}</td>
                    <td>
                        <a type="button" class="btn btn-success" href="{% url 'approve_pto_request' ptor.id %}">Approve</a>
                        <a type="button" class="btn btn-danger" href="{% url 'deny_pto_request' ptor.id %}">Deny</a>
                    </td>
                </tr>
              {% endfor %}
            </tbody>
        </table>
      {% else %}
        <div style="margin-bottom: 18px;"><h5>There are no open PTO requests needing approval.</h5></div>
      {% endif %}
    </div>

    <div class="tab-pane{% if active_tab == 'all_history' %} active{% endif %}" id="all_history">
      {% if pto_all_history|length %}
        <table id="pto_all_history" class="table table-striped table-bordered table-hover table-condensed">
            <thead><tr>
                <th>Employee</th>
                <th>Date</th>
                <th>Hours</th>
                <th>Comment</th>
                <th>PTO Request</th>
            </tr></thead>
            <tbody>
                {% for pto in pto_all_history %}
                <tr id="{{pto.id}}">
                    <td>{{ pto.user_profile }}</td>
                    <td>{{ pto.date }}</td>
                    <td>{{ pto.amount }}</td>
                    <td>{{ pto.comment }}</td>
                    <td>
                        {% if pto.pto_request %}
                        <a href="{% url 'pto_request_details' pto.pto_request.id %}">View PTO Request Details</a>
                        {% else %}
                        <label>---</label>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
      {% else %}
        <div style="margin-bottom: 18px;"><h5>There is no PTO history.</h5></div>
      {% endif %}
    </div>
    {% endif %}
    
</div>
{% endblock content %}

{% block extrajs %}
<script charset="utf-8" src="{{ STATIC_URL }}timepiece/js/permanent_tabs.js"></script>
<script>
var basePath = "{% url 'pto' %}",
    tabIds = ['summary', 'requests', 'history', 'approvals'],
    defaultTab = 'summary';
</script>
{% endblock extrajs %}
