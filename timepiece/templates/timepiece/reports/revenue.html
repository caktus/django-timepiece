{% extends "timepiece/reports/base.html" %}
{% load timepiece_tags bootstrap_toolkit %}
{% load url from future %}

{% block title %}Revenue Report{% endblock title %}

{% block extracss %}
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}timepiece/js/burnup_charts/c3.min.css" />
{% endblock extracss %}

{% block bodyid %}revenue-report{% endblock bodyid %}

{% block crumbs %}
    {{ block.super }}
    <li><span class="divider">/</span> <a href="{% url 'report_revenue' %}">Revenue Report</a></li>
{% endblock crumbs %}

{% block report_nav %}
    {% with 'revenue_report' as active %}
        {{ block.super }}
    {% endwith %}
{% endblock report_nav %}

{% block report_content %}
    <div class="row-fluid">
        <div class="span12">
            {% date_filters "report-filters" %}
        </div>
    </div>

    <div class="row-fluid">
        <div class="row-fluid">
            <form class="span12 form-horizontal" method="get" action="" id="report-filters" accept-charset="utf-8">
                {{ filter_form|as_bootstrap:"horizontal" }}
                <button type="submit" class="btn btn-primary" name="ok" id="update">Update Filters</button>
                <button type="submit" class="btn btn-success" name="export_revenue_report" value="True">Export Revenue Report</button>
            </form>
        </div>
    </div>

    <div class="row-fluid">
        <div class="span12">
            <div id="chart" class="chart" data-report="{{ report_data }}" data-axis="{{ axis_titles }}"></div>
        </div>
    </div>

    <div class="row-fluid">
        <div class="span12">
            {% if projects_with_no_contracts %}
            <div class="alert alert-block alert-error">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                This billable projects are not associated with a contract, therefore no rate information is available to calculate revenue:
                {% for project in projects_with_no_contracts %}
                    {% if forloop.last %}
                        {{ project.code }}
                    {% else %}
                        {{ project.code }}, 
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            {% if missing_rates %}
            <div class="alert alert-block alert-error">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                This following Contract + Activity combinations do not have associated rates, therefore $0.00/hr is used in the calculations for this report.:
                {% for missing_rate in missing_rates %}
                    {% if forloop.last %}
                        ({{ missing_rate.0 }} + {{ missing_rate.1 }})
                    {% else %}
                        ({{ missing_rate.0 }} + {{ missing_rate.1 }}), 
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            <h3>Employee Revenue by Project</h3>
            <table class="table table-bordered table-striped table-condensed">
                <thead>
                    <tr>
                        <th>Employee</th>
                        {% for project_code in project_headers %}
                            <th style="white-space: nowrap;">{{ project_code }}</th>
                        {% endfor %}
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                {% for name, pk, hours in rows %}
                    <tr>
                        <th style="white-space: nowrap;">{{ name }}</th>
                        {% for num in hours %}
                            <td style="white-space: nowrap;" class="hours" title="{{ name }}">$ {{ num|floatformat:2 }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
                <tr class="total">
                    <th>Total</th>
                    {% for total in totals %}
                        <td style="white-space: nowrap;" class="hours">$ {{ total|floatformat:2 }}</td>
                    {% endfor %}
                </tr>
                </tbody>
            </table>
        </div>
    </div>
{% endblock report_content %}

{% block extrajs %}
    {{ pj_filters.media }}
    {{ block.super }}
    <!--script charset="utf-8" src="{{ STATIC_URL }}timepiece/js/chart/revenue_chart.js"
            data-report="{{ report }}" data-type="{{ type }}"></script-->
    <script charset="utf-8" src="{{ STATIC_URL }}timepiece/js/burnup_charts/c3.min.js"></script>
    <script charset="utf-8" src="{{ STATIC_URL }}timepiece/js/burnup_charts/d3.min.js"></script>
    <script>
        var chart = document.getElementById('chart'),
        report = JSON.parse(chart.getAttribute('data-report')),
        titles = JSON.parse(chart.getAttribute('data-axis'));
        $(document).ready( function () {
            var chart = c3.generate({
                data: report,
                axis: {
                    x: {
                        type: 'category',
                        categories: titles.names
                    },
                    y: {
                        tick: {
                            format: d3.format("$,")
                        }
                    }
                }
            });
        });
    </script>
{% endblock extrajs %}