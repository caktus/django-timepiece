{% extends "timepiece/reports/base.html" %}
{% load timepiece_tags bootstrap_toolkit humanize %}
{% load url from future %}

{% block title %}Backlog Report{% endblock title %}

{% block extracss %}
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}timepiece/js/burnup_charts/c3.min.css" />
{% endblock extracss %}

{% block bodyid %}backlog-report{% endblock bodyid %}

{% block crumbs %}
    {{ block.super }}
    <li>
        <span class="divider">/</span>
        <a href="{% url 'report_backlog' %}">Backlog Report</a>
    </li>
{% endblock crumbs %}

{% block report_nav %}
    {% with 'backlog' as active %}
        {{ block.super }}
    {% endwith %}
{% endblock report_nav %}


{% block report_content %}
<div class="row-fluid">
    <div class="span12">
        <div class="accordion" id="filter-accordion">
            <div class="accordion-group">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#filter-accordion" href="#filters">
                    Apply Filters + Export CSV
                    </a>
                </div>
                <div id="filters" class="accordion-body collapse">
                    <div class="accordion-inner">
                     <form class="span10 form-horizontal" method="get" action="" id="report-filters" accept-charset="utf-8">
                        {{ backlogfilter_form|as_bootstrap:"horizontal" }}
                        <button type="submit" class="btn btn-primary" name="ok" id="filterbutton">Update Filters</button>
                        <button type="submit" class="btn btn-success" name="export_data" value="True">Export Activity Totals</button>
                        <button type="submit" class="btn btn-success" name="export_company_data" value="True">Export Detailed Data</button>
                    </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="span12" name="backlog-container">

        <ul class="nav nav-tabs">
            <li{% if active_tab == 'company' %} class="active"{% endif %}>
                {% url "report_backlog" "company" as link %}
                <a class="tab-link" to="company" href="{{ link|add_parameters:request.GET }}">Company Summary</a>
            </li>
            <li{% if active_tab == 'company-coverage' %} class="active"{% endif %}>
                {% url "report_backlog" "company-coverage" as link %}
                <a class="tab-link" to="company-coverage" href="{{ link|add_parameters:request.GET }}">Company Coverage</a>
            </li>
            <li{% if active_tab == 'individual-summary' %} class="active"{% endif %}>
                {% url "report_backlog" "individual-summary" as link %}
                <a class="tab-link" to="individual-summary" href="{{ link|add_parameters:request.GET }}">Employee Summary</a>
            </li>
            <li{% if active_tab == 'individual-details' %} class="active"{% endif %}>
                {% url "report_backlog" "individual-details" as link %}
                <a class="tab-link" to="individual-details" href="{{ link|add_parameters:request.GET }}">Employee Totals by Activity</a>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane{% if active_tab == 'company' %} active{% endif %}" id="company">
                <div class="span4">
                    <h3>Drop Dead Date: {{ company_backlog.drop_dead_date }}</h3>
                    <table class="table">
                        <tr>
                            <th>Activity</th>
                            <th>Hours</th>
                        </tr>
                        {% for activity_hours in company_backlog.company_total_hours %}
                            <tr id='activity-hours-{{ forloop.counter0 }}'{% if activity_hours.remaining_hours < 0 %} class="error"{% endif %}>
                                <td>{% if activity_hours.activity %}
                                    <a href="{% url 'report_activity_backlog' activity_hours.activity.id %}">
                                            {{ activity_hours.activity.name }}
                                    </a>
                                    {% else %}
                                    <a href="{% url 'report_activity_backlog' 0 %}">
                                        Other
                                    {% endif %}
                                    </a>
                                </td>
                                <td>{{ activity_hours.remaining_hours|floatformat:2|intcomma }}</td>
                            </tr>
                        {% endfor %}
                        <tr>
                            <th>TOTAL</th>
                            <th>{{ total_company_hours|floatformat:2|intcomma }}</th>
                        </tr>
                    </table>
                </div>
                <div class="span6 offset1">
                    <h3>Backlog by Activity</h3>
                    <div id="activity-breakdown-chart" data="{{ company_backlog.chart_data }}"></div>
                </div>
            </div>

            <div class="tab-pane{% if active_tab == 'company-coverage' %} active{% endif %}" id="company-coverage">
                {% if no_data %}
                <div class="row-fluid"><div class="span4"><div class="alert alert-danger">Your selected filter resulted in no data.</div></div></div>
                {% endif %}
                <div id="company-coverage-area-chart" style="overflow: none;" data="{{ chart_data }}">
                </div>
                <div id="company-chart-filters" class="row-fluid">
                    <h3>Filters <a class="btn btn-primary" href="#" onclick="apply_filters();return false;">Apply Filters</a></h3>
                    <div class="row-fluid"><div class="span4"><div class="alert alert-info">Filters can take a few moments to apply.</div></div></div>
                    <div class="span2">
                        <h4>Project Statuses</h4>
                        <div class="control-group">
                        <div class="controls">
                            {% for status in filters.project_statuses %}
                            <label class="checkbox">
                            <input type="checkbox" class="filters" name="project_statuses" value="{{ status.id }}" checked="checked">
                                {{ status.label }}
                            </label>
                            {% endfor %}
                        </div>
                        </div>
                    </div>
                    <div class="span2">
                        <h4>Project Types</h4>
                        <div class="control-group">
                        <div class="controls">
                            {% for type in filters.project_types %}
                            <label class="checkbox">
                            <input type="checkbox" class="filters" name="project_types" value="{{ type.id }}" checked="checked">
                                {{ type.label }}
                            </label>
                            {% endfor %}
                        </div>
                        </div>
                    </div>
                    <div class="span3">
                        <h4>Clients</h4>
                        <div class="control-group">
                        <div class="controls">
                            {% for client in filters.clients %}
                            <label class="checkbox">
                            <input type="checkbox" class="filters" name="clients" value="{{ client.id }}" checked="checked">
                                {{ client.label }}
                            </label>
                            {% endfor %}
                        </div>
                        </div>
                    </div>
                    <div class="span2">
                        <h4>Other</h4>
                        <div class="control-group">
                        <div class="controls">
                        {% for billable in filters.billable %}
                            <label class="checkbox">
                            <input type="checkbox" class="filters" name="billable" value="{{ billable.id }}" checked="checked">
                                {{ billable.label }}
                            </label>
                            {% endfor %}
                        </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="tab-pane{% if active_tab == 'individual-summary' %} active{% endif %}" id="individual-summary">
                <div class="alert alert-warning">
                    <a class="close" data-dismiss="alert" href="#">x</a>
                    Employees highlighted in yellow have exceeded their BHCe.
                </div>
                <table class="table">
                    <tr>
                        <th>Employee</th>
                        <th title="The last date the employee has available hours based on Activity Goals.">Drop Dead Date</th>
                        <th title="The total number of hours remaining based on Activity Goals.">Total Hours Remaining</th>
                        <th title="The number of approved time off hours included in reaching the Drop Dead Date.">Approved Time Off</th>
                        <th title="The number of holiday hours included in reaching the Drop Dead Date.">Included Holidays</th>
                    </tr>
                    {% for employee in backlog_summary %}
                        <tr{% if employee.employee.profile.exceeds_utilization %} class="warning"{% endif %}>
                            <td><a href="{% url 'report_employee_backlog' employee.employee.id %}">{{ employee.employee.first_name }} {{ employee.employee.last_name }}</a></td>
                            <td>{{ employee.drop_dead_date }}</td>
                            <td>{{ employee.total_available_hours }}</td>
                            <td>{{ employee.future_approved_time_off }}</td>
                            <td>{{ employee.future_holiday_time_off }}</td>
                        </tr>
                    {% endfor %}
                </table>
            </div>

            <div class="tab-pane{% if active_tab == 'individual-details' %} active{% endif %}" id="individual-details">
                <table class="table">
                    <tr>
                        <th>Employee</th>
                        <th>Activity</th>
                        <th style="width: 40%">Progress</th>
                        <th colspan="2">Hours</th>
                    </tr>
                    {% for employee, ags in backlog.items %}
                        {% for ag in ags %}
                        <tr>
                            {% if forloop.first %}
                            <td rowspan="{{ ags|length }}"><a href="{% url 'report_employee_backlog' ag.employee.id %}">{{ ag.employee.first_name }} {{ ag.employee.last_name }}</a></td>
                            {% endif %}
                            <td>{{ ag.activity_name }}</td>
                            <td>
                                <div class="progress{% if ag.hours == 0.0 %} progress-danger progress-striped{% endif %}{% if ag.charged_hours > ag.hours %} progress-danger{% endif %}">
                                    <div class="bar{% if ag.percentage == 100 %} bar-success{% endif %}" style="width: {{ ag.percentage }}%;"></div>
                                </div>
                            </td>
                            <td>{{ ag.charged_hours }} / {{ ag.hours }}</td>
                            <td><span class="label{% if ag.charged_hours > ag.hours %} label-important{% endif %}">{{ ag.remaining_hours }} remaining</span></td>
                        </tr>
                        {% endfor %}
                    {% endfor %}
                </table>
            </div>
    </div>
</div>
{% endblock report_content %}

{% block extrajs %}
{{ pj_filters.media }}

<script charset="utf-8" src="{{ STATIC_URL }}timepiece/js/burnup_charts/c3.min.js"></script>
<script charset="utf-8" src="{{ STATIC_URL }}timepiece/js/burnup_charts/d3.min.js"></script>
<script charset="utf-8" src="{{ STATIC_URL }}timepiece/js/burnup_charts/burnup_charts.js"></script>
<script>
    var pie_chart;
    var bar_chart;
    $(document).ready( function () {
        var data = $.parseJSON($('#activity-breakdown-chart').attr('data'))
        pie_chart = c3.generate({
            bindto: '#activity-breakdown-chart',
            data: {
                columns: data,
                type : 'donut',
                onclick: function (d, i) { console.log("onclick", d, i); },
                onmouseover: function (d, i) { $('#activity-hours-' + d.index).addClass('success'); },
                onmouseout: function (d, i) { $('#activity-hours-' + d.index).removeClass('success'); }
            },
            size: {
                height: 600,
            },
            legend: {
                show: true,
            },
            donut: {
                title: "",
                label: {//"Backlog by Activity",
                    format: function (value, ratio, id) {
                        return d3.format(',.2f')(value);
                    }
                }
            }
        });
        var chart_data = $.parseJSON($('#company-coverage-area-chart').attr('data'))
        var bar_chart = c3.generate({
            bindto: '#company-coverage-area-chart',
            data: {
                x: 'x',
                columns: chart_data['columns'],
                type: 'bar',
                types: {
                    'Total Avg Hours': 'scatter',
                    'Utilization Avg Hours': 'scatter'
                },
                groups: [chart_data['keys']],
            },
            axis: {
                x: {
                    type: 'timeseries',
                    tick: {
                        format: '%Y-%m-%d'
                    }
                }
            },
            size: {
                height: 500 + 8*Math.ceil(chart_data.keys.length/4),
            },
            tooltip: {
                show: false,
            },
            point: {
                show: true
            }
        });
    });

    function apply_filters() {
        var chart_data = $.parseJSON($('#company-coverage-area-chart').attr('data'));
        var bar_chart = c3.generate({
            bindto: '#company-coverage-area-chart',
            data: {
                x: 'x',
                columns: chart_data['columns'],
                type: 'bar',
                types: {
                    'Total Avg Hours': 'scatter',
                    'Utilization Avg Hours': 'scatter'
                },
                groups: [chart_data['keys']],
            },
            axis: {
                x: {
                    type: 'timeseries',
                    tick: {
                        format: '%Y-%m-%d'
                    }
                }
            },
            size: {
                height: 500 + 8*Math.ceil(chart_data.keys.length/4),
            },
            tooltip: {
                show: false,
            },
            point: {
                show: true
            }
        });
        var filters = chart_data['filters'];
        var project_types = $.map($('input:checked[name="project_types').filter('.filters'),
                function (option) {return $(option).attr('value');}),
            project_statuses = $.map($('input:checked[name="project_statuses').filter('.filters'),
                function (option) {return $(option).attr('value');}),
            billable = $.map($('input:checked[name="billable').filter('.filters'),
                function (option) {return $(option).attr('value');}),
            clients = $.map($('input:checked[name="clients').filter('.filters'),
                function (option) {return $(option).attr('value');});

        // toggle everything off
        bar_chart.toggle();
        bar_chart.toggle('Avg Hours');

        if (project_types.length == 0 || project_statuses.length == 0 || billable.length == 0 || clients.length == 0) {
            return;
        }

        var data, load,
            to_toggle = [];
        $.each(chart_data['keys'], 
            function( index, key ) {
                data = chart_data.filters.chart_filters[key];
                load = true;
                load &= project_statuses.indexOf(data['project-status'].toString()) >= 0;
                load &= project_types.indexOf(data['project-type'].toString()) >= 0;
                load &= clients.indexOf(data['client'].toString()) >= 0;
                load &= billable.indexOf(data['billable'].toString()) >= 0;
                if (load) {
                    // bar_chart.toggle(key);
                    to_toggle.push(key);
                }
            }
        );
        $.each(to_toggle,
            function (index, key) {
                bar_chart.toggle(key);
            }
        );
    }
</script>
{% endblock extrajs %}