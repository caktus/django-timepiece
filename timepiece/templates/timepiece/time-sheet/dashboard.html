{% extends "timepiece/time-sheet/base.html" %}
{% load timepiece_tags math_tags %}
{% load i18n %}

{% block title %}{% trans "Timepiece Entries" %}{% endblock title %}

{% block bodyid %}dashboard{% endblock bodyid %}

{% block content %}
    {% if view_entries %}
        <div class="row-fluid">
            <div class="span12">
                <h2>{% trans "My Time Sheet" %}</h2>
                <ul class="unstyled subnav">
                    <li><a href="{% url timepiece-clock-in %}">{% trans "Clock In" %}</a></li>
                    <li><a href="{% url timepiece-add %}">{% trans "Add Entry" %}</a></li>
                </ul>
            </div>
        </div>
    {% endif %}

    {% if view_entries %}
        <div class="row-fluid hidden-desktop">
            <div class="span12">
                <h3>
                    {% with entries.count as num_entries %}
                        {% trans "My Active Entries" %}
                    {% endwith %}
                </h3>

                {% with my_active_entries as entries %}
                    <div class="scroll">
                        {% include "timepiece/time-sheet/_entry_list.html" with active="True" %}
                    </div>
                {% endwith %}
            </div>
        </div>
    {% endif %}

    {% if assignments %}
        <div class="row-fluid">
            <div class="span12">
                <h3>{% trans "My Projects" %}</h3>
                <div class="scroll">
                    <table class="table table-striped table-bordered table-condensed">
                        <thead>
                            <tr>
                                <th>{% trans "Project" %}</th>
                                <th>{% trans "My Hours" %}</th>
                                <th>{% trans "Hours Worked" %}</th>
                                <th>{% trans "Hours Remaining" %}</th>
                                <th>{% trans "Due Date" %}</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% regroup assignments by contract.project.type as type_list %}
                            {% for type in type_list %}
                                <tr class="ledger_header">
                                    <th colspan="6">{{ type.grouper }}s</th>
                                </tr>
                                {% for assignment in type.list %}
                                    <tr>
                                        <td><a href="{% url timepiece-clock-in %}?project={{ assignment.contract.project.pk }}">{{ assignment.contract.project }}</a></td>
                                        <td class="hours">{{ assignment.num_hours }}</td>
                                        <td class="hours">{{ assignment.hours_worked|floatformat:2 }} ({% widthratio assignment.hours_worked assignment.num_hours 100 %}%)</td>
                                        <td class="hours">{{ assignment.hours_remaining|floatformat:2 }}</td>
                                        <td>{{ assignment.end_date }}</td>
                                        <td>
                                            <ul class="actions">
                                                <li><a href="{% url timepiece-add %}?project={{ assignment.contract.project.pk }}">{% trans "Add Entry" %}</a></li>
                                                {% if perms.timepiece.view_entry_summary %}
                                                    <li><a href="{% url view_contract assignment.contract.pk %}">{% trans "Report" %}</a></li>
                                                {% endif %}
                                            </ul>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}

    {% if view_entries %}
        <div class="row-fluid visible-desktop">
            <div class="span12">
                <h3>
                    {% with entries.count as num_entries %}
                        {% trans "My Active Entries" %}
                    {% endwith %}
                </h3>

                {% with my_active_entries as entries %}
                    <div class="scroll">
                        {% include "timepiece/time-sheet/_entry_list.html" with active="True" %}
                    </div>
                {% endwith %}
            </div>
        </div>
    {% endif %}

    <div class="row-fluid">
        {% if allocations or project_entries or my_active_entries %}
            <div class="span12">
                <h3>{% trans "My Work This Week" %}</h3>
                <table class="table table-bordered table-condensed">
                    <thead>
                        <tr>
                            <th>{% trans "Project" %}</th>
                            <th>{% trans "Hours Worked" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if my_active_entries %}
                            <tr class="ledger_header">
                                <th colspan="2">{% trans "Current Entry" %}</th>
                            </tr>

                            {% for entry in my_active_entries %}
                                <tr>
                                    <td><a href="{% url timepiece-clock-in %}?project={{ entry.project_id }}">{{ entry.project }}</a></td>
                                    <td class="hours">{% get_active_hours entry %}</td>
                                </tr>
                            {% endfor %}
                        {% endif %}

                        {% for assignment in allocations %}
                            <tr>
                                <td><a href="{% url timepiece-clock-in %}?project={{ assignment.assignment.contract.project.pk }}">{{ assignment.assignment.contract.project }}</a></td>
                                <td class="hours">
                                    {% bar_graph assignment.assignment.contract.project assignment.hours_worked assignment.hours %}
                                </td>
                            </tr>
                        {% endfor %}

                        {% if project_entries %}
                            <tr class="ledger_header">
                                <th colspan="2">{% trans "Past Entries" %}</th>
                            </tr>

                            {% for entry in project_entries %}
                                <tr>
                                    <td><a href="{% url timepiece-clock-in %}?project={{ entry.project__pk }}">{{ entry.project__name }}</a></td>
                                    <td class="hours">{{ entry.sum }}</td>
                                </tr>
                            {% endfor %}
                        {% endif %}

                        <tr class="ledger_header">
                            <th colspan="2">{% trans "Time Totals" %}</th>
                        </tr>

                        {% for row in activity_entries %}
                            <tr>
                                <th>{% trans "Total" %} {% if row.billable %}{% trans "billable" %}{% else %}{% trans "non-billable" %}{% endif %} {% trans "time" %}:</th>
                                <td class="hours">
                                    {{ row.sum }}
                                </td>
                            </tr>
                        {% endfor %}

                        <tr>
                            <th>{% trans "Total time this week" %}:</th>
                            <td class="hours">
                                {% ifnotequal schedule.count 0 %}
                                    {% bar_graph "" current_total schedule.0.hours_per_week %}
                                {% else %}
                                    {{ current_total }}
                                {% endifnotequal %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>


    {% if allocations %}
        <div class="row-fluid">
            <div style="height: 320px; width: 320px;" id="my-weekly-hours-chart"></div>
        </div>
    {% endif %}

    {% if view_entries %}
        <div class="row-fluid">
            <div class="span12">
                <h3>
                    {% with this_weeks_entries.count as num_entries %}
                        {% blocktrans with pl_entries=num_entries|pluralize:"y,ies" %}Time Detail This Week ({{ num_entries }} entr{{ pl_entries }}){% endblocktrans %}
                    {% endwith %}
                </h3>

                {% with this_weeks_entries as entries %}
                    <div class="scroll">
                        {% include "timepiece/time-sheet/_entry_list.html" %}
                    </div>
                {% endwith %}
            </div>
        </div>
    {% endif %}
{% endblock %}
